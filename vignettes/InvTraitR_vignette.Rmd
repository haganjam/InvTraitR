---
title: "Dry biomass of freshwater invertebrates using InvTraitR"
author: "James Hagan"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
---

To see how we can use *InvTraitR* to obtain estimates of the dry biomass of freshwater invertebrates using taxon names and geographical coordinates, we will start by loading some relevant packages and some test data. The test data consist of a set of 89 invertebrate taxa collected in freshwater rockpools on six rocky outcrops (often called inselbergs) in five countries.

In addition, the data consist of latitude-longitude coordinates for the samples as well as measured body lengths for all the taxa (some body lenghts were compiled from the literature)

```{r}
# until we can simply load the package, I'll load the functions and files manually

# load functions associated with the script
funcs <- list.files("R")
sapply(funcs, function(x) source(paste0("R/",x)))

# download the data files
db_files <- list("col_higher_taxon_matrices.rds",
                 "col_taxon_database.rds",
                 "equation_database.rds",
                 "freshwater_ecoregion_data.rds",
                 "freshwater_ecoregion_map.rds",
                 "freshwater_ecoregion_metadata.rds",
                 "gbif_higher_taxon_matrices.rds",
                 "gbif_taxon_database.rds",
                 "itis_higher_taxon_matrices.rds",
                 "itis_taxon_database.rds",
                 "taxon_database.rds")

# load the dbfiles
sapply(db_files, function(x) readRDS(paste0("database/",x)))

# load relevant libraries
library(dplyr)
library(readr)
library(tidyr)
library(ggplot2)

# load the test data
dol_df <- readr::read_csv("database/dolmans_MSc_2022.csv")
head(dol_df)

# how many unique taxa are there?
length(unique(dol_df$taxon))

# how many locations?
length(unique(dol_df$location))

# how many countries?
length(unique(dol_df$country_code_XXX))

# check the summary statistics
summary(dol_df)

```

We want to use the body length data to estimate the dry biomass for each of these samples using length-dry biomass allometric equations. The *InvTraitR* package houses a database of more than 350 length-dry biomass allometric equations that represent most major groups of freshwater invertebrates globally. We can use *InvTraitR* to search this database for appropriate length-dry biomass equations for the samples in our test data (`dol_df`).

To do this, we have two options both of which rely on the `get_trait_from_taxon()` function. This function (see below) takes a data.frame with at least five columns. These columns are the taxon name for which dry biomass data are required, the life stage of the taxon, the latitude and longitude coordinates from which the taxon was sampled and body size of the taxon:

```r
get_trait_from_taxon(
    data,                   # data.frame with at least five columns: target taxon, life stage, latitude (dd), longitude (dd) and body size (mm) if trait == "equation"
    target_taxon,           # character string with the column name containing the taxon names
    life_stage,             # character string with the column name containing the life stages
    latitude_dd,            # character string with the column name containing the latitude in decimal degrees
    longitude_dd,           # character string with the column name containing the longitude in decimal degrees
    body_size,              # character string with the column name containing the body size data if trait = "equation"
    workflow = "workflow2", # options are "workflow1" or "workflow2" (default = "workflow2)
    max_tax_dist = 3,       # maximum taxonomic distance acceptable between the target and the taxa in the database (default = 3)
    trait = "equation",     # trait to be searched for (default = "equation")
    gen_sp_dist = 0.5       # taxonomic distance between a genus and a species(default = 0.5)
)
```

The first option is *workflow1*. If *workflow1* is chosen, `get_trait_from_taxon()` will search the database and, for each sample in your dataset, it will output all equations that are within the maximum taxonomic distance (*max_tax_dist*) set by the user. We can then use our own discretion to choose which of these equations we would like to use.

Let's see how this works:

```{r}
# we specify the dol_df into the function
dol_df_equ <- get_trait_from_taxon(data = dol_df,
                                   target_taxon = "taxon",
                                   life_stage = "life_stage",
                                   latitude_dd = "lat",
                                   longitude_dd = "lon",
                                   body_size = "length_mm", 
                                   workflow = "workflow1",
                                   trait = "equation",
                                   max_tax_dist = 3.5,
                                   gen_sp_dist = 0.25)

```


The output is a list of length two with two different data.frames: the data with relevant equations (*data*) and a data.frame with information on how we chose the equations (*decision_df*).

```{r}

# look at the first few rows of both the output data.frames in the list
head(dol_df_equ$data)
head(dol_df_equ$decision_data)

```

We'll start by looking at the outputted data with the equations. To do this, let's simply look at the first row of the raw data that we fed into the function and what gets outputted:

```{r}
# check the first row of the data that we fed into the function
print(dol_df[1,])

# check the first row of the output data with the equations
print(dplyr::filter(dol_df_equ$data, row == 1))

```


