---
title: "InvTraitR project documentation"
output: html_notebook
---

### Preservation effects

The recommended approach to generating length-dry biomass equations is to use fresh specimens or frozen specimens (Benke et al. 1999). This is because preservation in commonly used preservatives like formalin and ethanol can cause mass loss as lipids and other compounds may dissolve. 

Loss in dry mass due to preservation can be substantial. For example, Mahrlein et al. (2016) report dry weight loss of more than 20% due to preservation in ethanol. Similarly, Wetzel et al. (2005) report dry weight loss of more than 30% due to both formalin and ethanol preservation. This is in contrast to the common doctrine that preservation-induced mass loss is less prevalent when animals are preserved in formalin (Leuven et al. 1985). These numbers (20 or 30%) are significant and, therefore, we should do our best to account for them to the best of our ability.

Generating equations or gathering test data that used different preservation methods can lead to a large additional source of error when estimating dry biomass. However, there is another issue with preservation methods. Usually, we want to estimate dry biomass for communities or species that were collected and preserved. However, individuals that are preserved in ethanol or formalin can also change their lengths. Thus, when these preserved individuals are measured for length, the measured lengths can be incorrect.

We need to look carefully at which preservation methods were used to generate the equation and which preservation is used for the testing data or for the dataset where the length data come from.

*What information do we need to extract?*

Add preservation method information for each equation. I think I'm going to stick with three possibilities:

+ unpreserved
+ formaldehyde
+ ethanol

Add a preservation correction factor for equations generated with preserved specimens. For example, Dekanova et al. (2022) generated their length-dry biomass equations using formalin-preserved specimens. We need to add some correction factor to these equations that increases the dry biomass estimate to account for this. For example, Mahrlein et al. (2016) propose a 22% correction factor but we'll need to check how consistent this is. The point is that we'll need to add a correction factor to each equation that was generated using preserved specimens. This will be based on the preservation method used.

In addition, we need to provide a length correction factor because preserved animals also change their length. Whether this length correction factor is required will depend on the preservation status of the equation:

+ length preserved -> equation unpreserved (correct length upwards)
+ length unpreserved -> equation preserved (correct length downwards)

The details of how to do this will depend and I'll need to figure it out. 

A nice comparison figure for the manuscript will be something like comparing accuracy of the method when accounting for preservation effects and when not accounting for preservation effects.

I think this is actually very important because most people that use these equations generally don't think too much about the preservation effects. This makes sense given that it's a lot of extra work. But, if it only needs to be done once (by us) then it might improve these biomass estimations a lot.


### Back-transformation problems for log-linear models

The problems with using log-linear models for prediction on the original scale of the response variable are well known (e.g. Marhrlein et al. 2016). Models of the form:

+ Y = a * X^b

Are typically transformed onto the log-scale as follows:

+ log(Y) = log(a) + b*log(X)

The problem with this transformation is that the errors become multiplicative and not additive on the log-scale. Thus, predictions of the expected value of Y become the geometric mean rather than the arithmetric which is always an underestimation. This means that predictions on the original-scale tend to be biased in such models.

Fortunately, there are various correction factors that are used to deal with this bias. The vast majority, however, rely on knowing the standard deviation of the model residuals (Neyman and Scott 1960). However, when researchers compile equations from the literature, usually they do not have access to the standard deviation of the residuals. This means that the typical correction factors do not work in these cases.

Strimbu et al. (2018) recently proposed a set of correction factors that work when access to the residuals of the model are not available. For FreshInvTraitR, we generally only have information on the equation, the range of X values that were used to fit the equation and the coefficient of determination (i.e. the r2 value). Using Strimbu et al.'s (2018) correction factors, this information tends to be sufficient.

Specifically, Strimbu et al. (2018) propose two correction factors that we may be able to use on log-linear equations in our database:

+ BC3 = exp( (0.5* (1 - r2)) * ( (1/log(a)) * (( log(ymax, b=a)-log(ymin, b=a) )/6))^2)

a - base of the logarithm
ymax - maximum y value
ymin - minimum y value
r2 - coefficient of determination of the log-linear model

The other correction factor that does not require r2 is:

+ BC4 = exp( (1/(log(a)^2)) * (( log(ymax, b=a)-log(ymin, b=a) )^2/72) )

Using these correction factors, we can calculate the unbiased expected Y value as:

+ unbiased Y(pred) = biased Y(pred) * ( BC3 | BC4 )

```{r}

# let's test these correction factors

e <- exp(1)

# simulate some lengths
x <- runif(50, 2.3, 5.5)

# simulate a y-variable from one of these equations
y <- 0.021*(x^2.315) + rnorm(n = 50, mean = 0, sd = 0.15)
plot(x, y)

# remove anything less than zero
rem <- y>0
x <- x[rem]
y <- y[rem]

# check the relationship
plot(x, y)

# lit a log-linear model
lm_log <- lm(log(y) ~ log(x))
summary(lm_log)

# get the r2
r2 <- summary(lm_log)$r.squared
print(r2)

# get the predictions
pred_log <- e^(predict(lm_log))

# plot the observed versus predicted values
plot(y, pred_log)
abline(a = 0, b = 1, col = "red")

# try this with the correction factors
a <- e
ymax <- max(y)
ymin <- min(y)
BC <- exp( (0.5* (1 - r2)) * ( (1/(log(a))) * (( log(ymax, b=a)-log(ymin, b=a) )/6))^2)
print(BC)

# try this with the true correction factor
BC <- exp(var(residuals(lm_log))/2)
print(BC)

# do the bias correction and check the prediction
# pred_cor <- (10^(predict(lm_log))) * BC
pred_cor <- (e^predict(lm_log))*BC

# plot the observed versus corrected predicted values
plot(y, pred_cor)
abline(a = 0, b = 1, col = "red")

# calculate the mean squared error
round(mean((y - pred_cor)^2), 6)
round(mean((y - pred_log)^2), 6)

# mean absolute error
round(mean(abs(y-pred_cor)), 6)
round(mean(abs(y-pred_log)), 6)

# mean percentage error
mean((abs(y - pred_cor)/y)*100)
mean((abs(y - pred_log)/y)*100)
```




